<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Weather</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root {
    --bg: #0b1120;
    --surface: #141c2e;
    --card: #1a2438;
    --card-hover: #1f2d45;
    --text: #eaf0f9;
    --muted: #7a8ba5;
    --accent: #38bdf8;
    --accent-glow: rgba(56, 189, 248, 0.15);
    --warm: #fb923c;
    --warm-glow: rgba(251, 146, 60, 0.12);
    --cool: #22d3ee;
    --rain: #a78bfa;
    --rain-glow: rgba(167, 139, 250, 0.12);
    --border: rgba(255,255,255,0.06);
    --border-light: rgba(255,255,255,0.1);
    --radius: 16px;
    --radius-sm: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* ── Header ── */
  header {
    position: relative;
    text-align: center;
    padding: 3rem 1.5rem 2rem;
    background: linear-gradient(170deg, #0f1b33 0%, #162040 40%, #1a2850 100%);
    overflow: hidden;
  }

  header::before {
    content: '';
    position: absolute;
    top: -40%;
    left: 50%;
    transform: translateX(-50%);
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(56,189,248,0.08) 0%, transparent 70%);
    pointer-events: none;
  }

  header h1 {
    position: relative;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1.2;
  }

  header h1 span {
    background: linear-gradient(135deg, var(--accent) 0%, #818cf8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  header p {
    position: relative;
    color: var(--muted);
    font-size: 0.85rem;
    margin-top: 0.5rem;
    font-weight: 400;
  }

  /* ── Controls ── */
  .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 1.5rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(12px);
  }

  select {
    appearance: none;
    background: var(--card);
    color: var(--text);
    border: 1px solid var(--border-light);
    padding: 0.6rem 2.2rem 0.6rem 0.9rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a8ba5'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.7rem center;
  }

  select:hover { border-color: rgba(255,255,255,0.15); }
  select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

  .unit-toggle {
    background: var(--card);
    color: var(--accent);
    border: 1px solid var(--border-light);
    padding: 0.45rem 0.7rem;
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    min-width: 2.5rem;
    text-align: center;
  }

  .unit-toggle:hover { border-color: var(--accent); background: var(--accent-glow); }
  .unit-toggle:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

  .status {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 400;
  }

  .status.error { color: #f87171; }

  /* ── Cards Grid ── */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    padding: 1.5rem;
    max-width: 1100px;
    margin: 0 auto;
  }

  /* ── Card ── */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--warm) 0%, var(--accent) 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border-color: var(--border-light);
  }

  .card:hover::before { opacity: 1; }

  .card[data-href] { cursor: pointer; }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .card-date {
    font-size: 0.75rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
  }

  .card-day {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
    margin-top: 0.15rem;
  }

  .card-icon {
    font-size: 1.8rem;
    line-height: 1;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .card-temps {
    display: flex;
    align-items: flex-end;
    gap: 0.6rem;
    margin-bottom: 0.25rem;
  }

  .temp-high {
    font-size: 2.8rem;
    font-weight: 700;
    letter-spacing: -0.04em;
    line-height: 1;
    background: linear-gradient(180deg, #fdba74 0%, #fb923c 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .temp-divider {
    font-size: 1.5rem;
    color: var(--border-light);
    font-weight: 300;
    margin-bottom: 0.2rem;
  }

  .temp-low {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--cool);
    margin-bottom: 0.15rem;
    text-decoration: none;
  }

  a.temp-low:hover { text-decoration: underline; }

  .temp-label {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 500;
    margin-top: 0.35rem;
  }

  /* ── Rain ── */
  .rain-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.5rem 0.7rem;
    background: var(--rain-glow);
    border-radius: var(--radius-sm);
    font-size: 0.82rem;
    color: var(--rain);
    font-weight: 500;
    text-decoration: none;
    transition: background 0.15s;
  }

  a.rain-row:hover { background: rgba(167, 139, 250, 0.2); }

  .rain-bar-track {
    flex: 1;
    height: 4px;
    background: rgba(167, 139, 250, 0.15);
    border-radius: 2px;
    overflow: hidden;
  }

  .rain-bar-fill {
    height: 100%;
    background: var(--rain);
    border-radius: 2px;
    transition: width 0.4s ease;
  }

  /* ── Chart ── */
  .chart {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }

  .chart-label {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .chart-bars {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 56px;
  }

  .chart-bar {
    flex: 1;
    border-radius: 3px 3px 0 0;
    min-width: 8px;
    position: relative;
    transition: opacity 0.15s;
    cursor: default;
  }

  .chart-bar:hover { opacity: 1 !important; }

  .chart-bar .tip {
    display: none;
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: #0f172a;
    color: var(--text);
    font-size: 0.7rem;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 6px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    border: 1px solid var(--border-light);
  }

  .chart-bar:hover .tip { display: block; }

  .chart-axis {
    display: flex;
    justify-content: space-between;
    font-size: 0.6rem;
    color: var(--muted);
    margin-top: 4px;
    font-weight: 500;
  }

  /* ── Loading ── */
  .loading {
    text-align: center;
    padding: 5rem 1.5rem;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .spinner {
    display: inline-block;
    width: 28px;
    height: 28px;
    border: 3px solid var(--border-light);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Fade-in animation ── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card { animation: fadeUp 0.35s ease both; }
  .card:nth-child(2) { animation-delay: 0.05s; }
  .card:nth-child(3) { animation-delay: 0.1s; }
  .card:nth-child(4) { animation-delay: 0.15s; }
  .card:nth-child(5) { animation-delay: 0.2s; }
  .card:nth-child(6) { animation-delay: 0.25s; }
  .card:nth-child(7) { animation-delay: 0.3s; }

  /* ── Footer ── */
  footer {
    text-align: center;
    padding: 2rem 1.5rem;
    color: var(--muted);
    font-size: 0.72rem;
    border-top: 1px solid var(--border);
    margin-top: 1rem;
  }

  footer a { color: var(--accent); text-decoration: none; font-weight: 500; }
  footer a:hover { text-decoration: underline; }

  /* ── Mobile ── */
  @media (max-width: 640px) {
    header { padding: 2rem 1rem 1.5rem; }
    header h1 { font-size: 1.6rem; }

    .controls { padding: 0.75rem 1rem; }
    select { width: 100%; font-size: 1rem; padding: 0.7rem 2.2rem 0.7rem 0.9rem; }

    .cards {
      grid-template-columns: 1fr;
      gap: 0.75rem;
      padding: 0.75rem;
    }

    .card { padding: 1.25rem; border-radius: 14px; }
    .temp-high { font-size: 2.4rem; }
    .temp-low { font-size: 1.3rem; }
    .card-icon { font-size: 1.5rem; }
    .chart-bars { height: 48px; }
  }

  @media (max-width: 380px) {
    .cards { padding: 0.5rem; }
    .card { padding: 1rem; }
    .temp-high { font-size: 2rem; }
  }

  /* ── Safe area for notch phones ── */
  @supports (padding: env(safe-area-inset-top)) {
    header { padding-top: calc(2rem + env(safe-area-inset-top)); }
    .controls { padding-left: calc(1rem + env(safe-area-inset-left)); padding-right: calc(1rem + env(safe-area-inset-right)); }
    .cards { padding-left: calc(1rem + env(safe-area-inset-left)); padding-right: calc(1rem + env(safe-area-inset-right)); }
    footer { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
  }
</style>
</head>
<body>

<header>
  <h1>Market <span>Weather</span></h1>
  <p>Forecasts derived from Kalshi prediction markets</p>
</header>

<div class="controls">
  <select id="city-select"></select>
  <button id="unit-toggle" class="unit-toggle" aria-label="Toggle temperature unit">°F</button>
  <span class="status" id="status"></span>
</div>

<div id="content">
  <div class="loading"><div class="spinner"></div><br>Loading forecast...</div>
</div>

<footer>
  Data from <a href="https://kalshi.com" target="_blank" rel="noopener">Kalshi</a> prediction markets.
  Reflects market consensus, not a traditional weather forecast.
</footer>

<script>
const CITIES = [
  "New York", "Chicago", "Miami", "Denver", "Austin", "Los Angeles",
  "Las Vegas", "Washington DC", "Seattle", "New Orleans", "San Francisco", "Philadelphia"
];

function toSlug(city) {
  return city.toLowerCase().replace(/\s+/g, '-');
}

function fromSlug(slug) {
  return CITIES.find(c => toSlug(c) === slug) || null;
}

function navigateTo(city) {
  const qs = useCelsius ? "?unit=c" : "";
  history.pushState(null, "", "/" + toSlug(city) + qs);
  document.title = `${city} Weather — Market Weather`;
  loadCity(city);
}

function cityFromPath() {
  const slug = location.pathname.replace(/^\/+|\/+$/g, '');
  if (!slug) return CITIES[0];
  return fromSlug(slug) || CITIES[0];
}

const select = document.getElementById("city-select");
const content = document.getElementById("content");
const statusEl = document.getElementById("status");
const unitBtn = document.getElementById("unit-toggle");

let useCelsius = new URLSearchParams(location.search).get("unit") === "c";
let lastData = null;

function fToC(f) { return Math.round((f - 32) * 5 / 9); }
function temp(f) { return useCelsius ? fToC(f) : f; }
function unitLabel() { return useCelsius ? "°C" : "°F"; }

function updateUnitBtn() { unitBtn.textContent = useCelsius ? "°C" : "°F"; }

function updateURL() {
  const params = new URLSearchParams(location.search);
  if (useCelsius) params.set("unit", "c");
  else params.delete("unit");
  const qs = params.toString();
  const path = location.pathname + (qs ? "?" + qs : "");
  history.replaceState(null, "", path);
}

CITIES.forEach(city => {
  const opt = document.createElement("option");
  opt.value = city;
  opt.textContent = city;
  select.appendChild(opt);
});

select.addEventListener("change", () => navigateTo(select.value));
unitBtn.addEventListener("click", () => {
  useCelsius = !useCelsius;
  updateUnitBtn();
  updateURL();
  if (lastData) renderCards(lastData.highs, lastData.lows, lastData.rains);
});
window.addEventListener("popstate", () => {
  useCelsius = new URLSearchParams(location.search).get("unit") === "c";
  updateUnitBtn();
  const city = cityFromPath();
  select.value = city;
  loadCity(city);
});

function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr + "T12:00:00");
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  return `${months[d.getMonth()]} ${d.getDate()}`;
}

function formatDay(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr + "T12:00:00");
  const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  if (d.toDateString() === today.toDateString()) return "Today";
  if (d.toDateString() === tomorrow.toDateString()) return "Tomorrow";
  return days[d.getDay()];
}

function weatherIcon(temp, rain) {
  if (rain != null && rain > 50) return "\u{1F327}\u{FE0F}";
  if (rain != null && rain > 20) return "\u{26C5}";
  if (temp != null && temp >= 85) return "\u{2600}\u{FE0F}";
  if (temp != null && temp >= 60) return "\u{1F324}\u{FE0F}";
  if (temp != null && temp >= 32) return "\u{2601}\u{FE0F}";
  return "\u{2744}\u{FE0F}";
}

function barColor(prob, maxProb) {
  const ratio = prob / maxProb;
  if (ratio > 0.7) return "rgba(56, 189, 248, 0.85)";
  if (ratio > 0.4) return "rgba(56, 189, 248, 0.55)";
  return "rgba(56, 189, 248, 0.3)";
}

function bandLabel(b) {
  if (b.label.startsWith('>')) return `>${temp(b.low)}${unitLabel()}`;
  if (b.label.startsWith('<')) return `<${temp(b.high)}${unitLabel()}`;
  return `${temp(b.low)}-${temp(b.high)}${unitLabel()}`;
}

function renderCards(highs, lows, rains) {
  lastData = { highs, lows, rains };

  const lowMap = {};
  lows.forEach(l => { if (l) lowMap[l.date] = l; });
  const rainMap = {};
  rains.forEach(r => { if (r) rainMap[r.date] = r; });

  if (!highs.length) {
    content.innerHTML = '<div class="loading">No forecast data available for this city.</div>';
    return;
  }

  highs.sort((a, b) => (a.date || "").localeCompare(b.date || ""));
  const u = unitLabel();

  const html = '<div class="cards">' + highs.map(h => {
    const lowData = lowMap[h.date];
    const low = lowData ? lowData.expected : null;
    const rainData = rainMap[h.date];
    const rain = rainData ? rainData.chance : null;
    const maxProb = Math.max(...h.bands.map(b => b.prob), 0.01);
    const icon = weatherIcon(h.expected, rain);

    return `<div class="card" data-href="${h.url}">
      <div class="card-header">
        <div>
          <div class="card-date">${formatDate(h.date)}</div>
          <div class="card-day">${formatDay(h.date)}</div>
        </div>
        <div class="card-icon">${icon}</div>
      </div>
      <div class="card-temps">
        <div class="temp-high">${h.expected != null ? temp(h.expected) + '\u00B0' : '\u2014'}</div>
        ${low != null && lowData.url ? `<div class="temp-divider">/</div><a class="temp-low" href="${lowData.url}" target="_blank" rel="noopener">${temp(low)}\u00B0</a>` : low != null ? `<div class="temp-divider">/</div><div class="temp-low">${temp(low)}\u00B0</div>` : ''}
      </div>
      <div class="temp-label">${low != null ? 'High / Low' : 'Expected High'}</div>
      ${rain != null && rainData.url ? `<a class="rain-row" href="${rainData.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">
        <span>\u{1F4A7}</span>
        <span>${rain}%</span>
        <div class="rain-bar-track"><div class="rain-bar-fill" style="width:${rain}%"></div></div>
      </a>` : rain != null ? `<div class="rain-row">
        <span>\u{1F4A7}</span>
        <span>${rain}%</span>
        <div class="rain-bar-track"><div class="rain-bar-fill" style="width:${rain}%"></div></div>
      </div>` : ''}
      <div class="chart">
        <div class="chart-label">Probability Distribution</div>
        <div class="chart-bars">
          ${h.bands.map(b => {
            const pct = (b.prob / maxProb) * 100;
            return `<div class="chart-bar" style="height:${Math.max(pct, 4)}%;background:${barColor(b.prob, maxProb)};opacity:0.9">
              <span class="tip">${bandLabel(b)}: ${Math.round(b.prob * 100)}%</span>
            </div>`;
          }).join('')}
        </div>
        <div class="chart-axis">
          <span>${bandLabel(h.bands[0])}</span>
          <span>${bandLabel(h.bands[h.bands.length - 1])}</span>
        </div>
      </div>
    </div>`;
  }).join('') + '</div>';

  content.innerHTML = html;
  content.querySelectorAll('.card[data-href]').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('a')) return;
      window.open(card.dataset.href, '_blank', 'noopener');
    });
  });
}

async function loadCity(city) {
  select.value = city;
  content.innerHTML = '<div class="loading"><div class="spinner"></div><br>Loading forecast...</div>';
  statusEl.textContent = "";
  statusEl.className = "status";

  try {
    const slug = toSlug(city);
    const resp = await fetch(`/api/city?name=${slug}`);
    if (!resp.ok) throw new Error(`API ${resp.status}`);
    const { highs, lows, rains } = await resp.json();

    renderCards(highs || [], lows || [], rains || []);

    const now = new Date();
    statusEl.textContent = `Updated ${now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = `Error: ${err.message}`;
    statusEl.className = "status error";
    content.innerHTML = '<div class="loading">Failed to load data. Please try again.</div>';
  }
}

updateUnitBtn();
const initialCity = cityFromPath();
select.value = initialCity;
if (location.pathname === '/') history.replaceState(null, "", "/" + toSlug(initialCity) + (useCelsius ? "?unit=c" : ""));
document.title = `${initialCity} Weather — Market Weather`;
loadCity(initialCity);
</script>
</body>
</html>
